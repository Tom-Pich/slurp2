(()=>{"use strict";var __webpack_modules__={771:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{function calculate(str){if(null===str)return"";let result;str=str.replace(/[+-]+$/g,""),str=str.replace(/[^-\(\)\d/\*+\.]/g,"");try{result=eval(str)}catch(e){result=""}return result=void 0===result?"":result,result}function int(e){return isNaN(parseInt(e))?0:parseInt(e)}function coarseRound(e){let t=!1;return e<0&&(e*=-1,t=!0),e=e<50?Math.round(e):e<200?5*Math.round(e/5):e<500?10*Math.round(e/10):e<2e3?50*Math.round(e/50):100*Math.round(e/100),t&&(e*=-1),e}function trimModifier(e){return(e=e.replace(/\([+-]\d+\)$/g,"")).trimEnd()}function explicitSign(e){return e>0?`+${e}`:`${e}`}__webpack_require__.d(__webpack_exports__,{Kf:()=>calculate,e$:()=>int})}},__webpack_module_cache__={};function __webpack_require__(e){var t=__webpack_module_cache__[e];if(void 0!==t)return t.exports;var a=__webpack_module_cache__[e]={exports:{}};return __webpack_modules__[e](a,a.exports,__webpack_require__),a.exports}__webpack_require__.d=(e,t)=>{for(var a in t)__webpack_require__.o(t,a)&&!__webpack_require__.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},__webpack_require__.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var __webpack_exports__={};(()=>{const e=e=>document.querySelector(e),t=e=>document.querySelectorAll(e);var a=__webpack_require__(771);const n="site-jdr"===window.location.hostname?"ws://127.0.0.1:1337":"wss://web-chat.pichegru.net:443";class r{constructor(e,t,a,n,r=[],o=null){this.sender=parseInt(e),this.key=t,this.type=a,this.timestamp=Date.now(),this.content=n,this.recipients=r,this.label=o}stringify(){return JSON.stringify(this)}}var o,i="undefined"==typeof document?void 0:document,d=!!i&&"content"in i.createElement("template"),c=!!i&&i.createRange&&"createContextualFragment"in i.createRange();function s(e,t){var a,n,r=e.nodeName,o=t.nodeName;return r===o||(a=r.charCodeAt(0),n=o.charCodeAt(0),a<=90&&n>=97?r===o.toUpperCase():n<=90&&a>=97&&o===r.toUpperCase())}function l(e,t,a){e[a]!==t[a]&&(e[a]=t[a],e[a]?e.setAttribute(a,""):e.removeAttribute(a))}var u={OPTION:function(e,t){var a=e.parentNode;if(a){var n=a.nodeName.toUpperCase();"OPTGROUP"===n&&(n=(a=a.parentNode)&&a.nodeName.toUpperCase()),"SELECT"!==n||a.hasAttribute("multiple")||(e.hasAttribute("selected")&&!t.selected&&(e.setAttribute("selected","selected"),e.removeAttribute("selected")),a.selectedIndex=-1)}l(e,t,"selected")},INPUT:function(e,t){l(e,t,"checked"),l(e,t,"disabled"),e.value!==t.value&&(e.value=t.value),t.hasAttribute("value")||e.removeAttribute("value")},TEXTAREA:function(e,t){var a=t.value;e.value!==a&&(e.value=a);var n=e.firstChild;if(n){var r=n.nodeValue;if(r==a||!a&&r==e.placeholder)return;n.nodeValue=a}},SELECT:function(e,t){if(!t.hasAttribute("multiple")){for(var a,n,r=-1,o=0,i=e.firstChild;i;)if("OPTGROUP"===(n=i.nodeName&&i.nodeName.toUpperCase()))i=(a=i).firstChild;else{if("OPTION"===n){if(i.hasAttribute("selected")){r=o;break}o++}!(i=i.nextSibling)&&a&&(i=a.nextSibling,a=null)}e.selectedIndex=r}}};function p(){}function f(e){if(e)return e.getAttribute&&e.getAttribute("id")||e.id}const m=function(e,t,a){if(a||(a={}),"string"==typeof t)if("#document"===e.nodeName||"HTML"===e.nodeName||"BODY"===e.nodeName){var n=t;(t=i.createElement("html")).innerHTML=n}else r=(r=t).trim(),t=d?function(e){var t=i.createElement("template");return t.innerHTML=e,t.content.childNodes[0]}(r):c?function(e){return o||(o=i.createRange()).selectNode(i.body),o.createContextualFragment(e).childNodes[0]}(r):function(e){var t=i.createElement("body");return t.innerHTML=e,t.childNodes[0]}(r);else 11===t.nodeType&&(t=t.firstElementChild);var r,l=a.getNodeKey||f,m=a.onBeforeNodeAdded||p,h=a.onNodeAdded||p,v=a.onBeforeElUpdated||p,_=a.onElUpdated||p,b=a.onBeforeNodeDiscarded||p,g=a.onNodeDiscarded||p,y=a.onBeforeElChildrenUpdated||p,w=a.skipFromChildren||p,E=a.addChild||function(e,t){return e.appendChild(t)},N=!0===a.childrenOnly,S=Object.create(null),A=[];function x(e){A.push(e)}function k(e,t){if(1===e.nodeType)for(var a=e.firstChild;a;){var n=void 0;t&&(n=l(a))?x(n):(g(a),a.firstChild&&k(a,t)),a=a.nextSibling}}function T(e,t,a){!1!==b(e)&&(t&&t.removeChild(e),g(e),k(e,a))}function C(e){h(e);for(var t=e.firstChild;t;){var a=t.nextSibling,n=l(t);if(n){var r=S[n];r&&s(t,r)?(t.parentNode.replaceChild(r,t),$(r,t)):C(t)}else C(t);t=a}}function $(e,t,a){var n=l(t);if(n&&delete S[n],!a){if(!1===v(e,t))return;if(function(e,t){var a,n,r,o,i=t.attributes;if(11!==t.nodeType&&11!==e.nodeType){for(var d=i.length-1;d>=0;d--)n=(a=i[d]).name,r=a.namespaceURI,o=a.value,r?(n=a.localName||n,e.getAttributeNS(r,n)!==o&&("xmlns"===a.prefix&&(n=a.name),e.setAttributeNS(r,n,o))):e.getAttribute(n)!==o&&e.setAttribute(n,o);for(var c=e.attributes,s=c.length-1;s>=0;s--)n=(a=c[s]).name,(r=a.namespaceURI)?(n=a.localName||n,t.hasAttributeNS(r,n)||e.removeAttributeNS(r,n)):t.hasAttribute(n)||e.removeAttribute(n)}}(e,t),_(e),!1===y(e,t))return}"TEXTAREA"!==e.nodeName?function(e,t){var a,n,r,o,d,c=w(e,t),p=t.firstChild,f=e.firstChild;e:for(;p;){for(o=p.nextSibling,a=l(p);!c&&f;){if(r=f.nextSibling,p.isSameNode&&p.isSameNode(f)){p=o,f=r;continue e}n=l(f);var h=f.nodeType,v=void 0;if(h===p.nodeType&&(1===h?(a?a!==n&&((d=S[a])?r===d?v=!1:(e.insertBefore(d,f),n?x(n):T(f,e,!0),n=l(f=d)):v=!1):n&&(v=!1),(v=!1!==v&&s(f,p))&&$(f,p)):3!==h&&8!=h||(v=!0,f.nodeValue!==p.nodeValue&&(f.nodeValue=p.nodeValue))),v){p=o,f=r;continue e}n?x(n):T(f,e,!0),f=r}if(a&&(d=S[a])&&s(d,p))c||E(e,d),$(d,p);else{var _=m(p);!1!==_&&(_&&(p=_),p.actualize&&(p=p.actualize(e.ownerDocument||i)),E(e,p),C(p))}p=o,f=r}!function(e,t,a){for(;t;){var n=t.nextSibling;(a=l(t))?x(a):T(t,e,!0),t=n}}(e,f,n);var b=u[e.nodeName];b&&b(e,t)}(e,t):u.TEXTAREA(e,t)}!function e(t){if(1===t.nodeType||11===t.nodeType)for(var a=t.firstChild;a;){var n=l(a);n&&(S[n]=a),e(a),a=a.nextSibling}}(e);var q,D,L=e,I=L.nodeType,M=t.nodeType;if(!N)if(1===I)1===M?s(e,t)||(g(e),L=function(e,t){for(var a=e.firstChild;a;){var n=a.nextSibling;t.appendChild(a),a=n}return t}(e,(q=t.nodeName,(D=t.namespaceURI)&&"http://www.w3.org/1999/xhtml"!==D?i.createElementNS(D,q):i.createElement(q)))):L=t;else if(3===I||8===I){if(M===I)return L.nodeValue!==t.nodeValue&&(L.nodeValue=t.nodeValue),L;L=t}if(L===t)g(e);else{if(t.isSameNode&&t.isSameNode(L))return;if($(L,t,N),A)for(var O=0,P=A.length;O<P;O++){var U=S[A[O]];U&&T(U,U.parentNode,!1)}}return!N&&L!==e&&e.parentNode&&(L.actualize&&(L=L.actualize(e.ownerDocument||i)),e.parentNode.replaceChild(L,e)),L};function h(e,t){return new Promise(((a,n)=>{try{const n=(new DOMParser).parseFromString(t,"text/html").querySelector(e),r=document.querySelector(e);m(r,n,{onBeforeElUpdated:function(e,t){if("DETAILS"===e.tagName&&e.id===t.id&&(t.open=e.open),"ignore"===e.dataset.morphdom)return!1}}),a("DOM updated successfully")}catch(e){n(e)}}))}async function v(e,t=null){const a={method:"get"};return t&&(a.method="post",a.body=t),fetch(e,a).then((e=>e.json())).then((e=>e.data))}const _=e("#ws-data").dataset.sessionId,b=e("#ws-data").dataset.wsKey,g=t("[data-group]"),y=new WebSocket(n);function w(e){e.querySelectorAll("[data-role=pdx-cell]").forEach((e=>{e.value=(0,a.Kf)(e.value)})),e.getAttribute("id");const t=new FormData(e);fetch("/submit/update-character-state",{method:"post",body:t}).then((()=>{const e=new r(_,b,"character-ping",parseInt(t.get("id")));y.send(e.stringify())}))}y.onopen=()=>{},y.onmessage=e=>{const t=JSON.parse(e.data);"character-ping"===t.type&&fetch("gestionnaire-mj").then((e=>e.text())).then((e=>{h(`#state-form-character-${t.content}`,e).then((()=>N(parseInt(t.content))))}))},t("[data-role=pdx-cell]").forEach((e=>{e.addEventListener("blur",(t=>{if(t.target.value){const n=(0,a.Kf)(t.target.value);e.value=n}}))})),t("[data-role=export-character]").forEach((t=>{t.addEventListener("click",(t=>{const a=t.target.dataset.id;let n=new FormData;n.append("id",a),fetch("/submit/export-character",{method:"post",body:n}).then((e=>e.text())).then((t=>{e(`#confirm-export-${a}`).innerText=t}))}))})),g.forEach((e=>{"true"===localStorage.getItem(`group-${e.dataset.group}`)&&e.setAttribute("open",!0),e.addEventListener("toggle",(t=>{const a=t.target.hasAttribute("open");localStorage.setItem(`group-${e.dataset.group}`,a)}))})),t("[data-role=character-state-form]").forEach((t=>{const n=t.querySelector("[data-role=save-character]");let r=!0;t.addEventListener("submit",(e=>{e.preventDefault(),w(t)})),n.addEventListener("click",(e=>{e.preventDefault(),w(t)})),t.addEventListener("change",(()=>{r&&n.classList.add("clr-invalid"),r=!0})),t.addEventListener("keydown",(e=>{e.ctrlKey&&"s"===e.key&&(e.preventDefault(),w(t),r=!1)})),t.addEventListener("click",(async t=>{const n=t.target;if(n.hasAttribute("data-details")){const t=(0,a.e$)(n.dataset.id),r=e("[data-name=details]");if("avdesav"===n.dataset.type||"power"===n.dataset.type&&"avantage"===n.dataset.origin){const e=await v("/api/get-avdesav?id="+t);r.querySelector("h4").innerText=`${e.name} (${e.displayCost})`,r.querySelector("div").innerHTML=e.description}if("power"===n.dataset.type&&"sort"===n.dataset.origin){const e=await v("/api/get-spell?id="+t);r.querySelector("h4").innerText=`${e.name} (${e.readableNiv})`,r.querySelector("div").innerHTML=e.fullDescription}r.showModal(),document.activeElement.blur()}}))}));const E=e("#items-form");function N(t){const a=new FormData;a.append("id",t),fetch("/api/get-character",{method:"post",body:a}).then((e=>e.json())).then((e=>e.data)).then((a=>{!function(t,a){const n=e("#state-form-character-"+t).querySelector("[data-role=character-summary]"),r=e("#character-details").content.cloneNode(!0);S(r,"Description",a.description),["For","Dex","Int","San","Per","Vol","Réflexes","Sang-Froid","Vitesse"].forEach((e=>{S(r,e,a.attributes[e])})),["PdVm","PdFm","PdMm","PdEm"].forEach((e=>{S(r,e,a.pdxm[e])})),S(r,"Dégâts",a.attributes["Dégâts"].estoc+"/"+a.attributes["Dégâts"].taille);const o=[];["Avantage","Désavantage","Travers","Réputation"].forEach((e=>{const t=a.avdesav.filter((t=>t.catégorie===e&&!o.includes(t.id))),n=[];t.forEach((e=>{let t;t=e.description?`<span data-details data-type="avdesav" data-id="${e.id}">${e.nom} (${e.points})</span>`:`${e.nom} (${e.points})`,n.push(t)})),S(r,e,n.join(", "))}));const i=a.colleges.map((e=>`${e.name}–${e.score}`)),d=i.length?`<b>Collèges&nbsp;:</b> ${i.join(", ")}`:"";S(r,"Collèges",d);const c=a.powers.map((e=>`<span data-details data-type="power" data-id="${e.data.data.id}" data-origin="${e.data.specific.Type||e.data.origin}" >${e.label}</span>`)),s=c.length?`<b>Pouvoirs&nbsp;:</b> ${c.join(", ")}`:"";S(r,"Pouvoirs",s),S(r,"Encombrement",`${a.state.Encombrement.name} (${a.carried_weight}&nbsp;kg)`);const l=a.equipment[0].liste.map((e=>`<span title="${e.notes} – ${e.secret}">${e.name}</span>`));S(r,"Équipement",l.join(", ")),n.innerHTML="",n.appendChild(r)}(t,a)}))}function S(e,t,a){""===a?e.querySelector(`[data-content=${t}]`).remove():e.querySelector(`[data-content=${t}]`).innerHTML=a}E.addEventListener("submit",(e=>{e.preventDefault(),fetch("/submit/equipment-list",{method:"post",body:new FormData(E)}).then((()=>{fetch("/gestionnaire-mj").then((e=>e.text())).then((e=>{h("#items-form",e)}))}))})),g.forEach((e=>{e.addEventListener("toggle",(t=>{e.open&&e.querySelectorAll("[data-role=character-state-form]").forEach((e=>{const t=e.querySelector("[name=Statut]").value,a=parseInt(e.querySelector("[name=id]").value);["Création","Actif"].includes(t)&&N(a)}))}))}));const A=e("[data-role=character-creation-form]");A.addEventListener("change",(e=>{"kit_ange"===e.target.name&&e.target.checked&&(A.kit_demon.checked=!1),"kit_demon"===e.target.name&&e.target.checked&&(A.kit_ange.checked=!1)})),A.addEventListener("submit",(t=>{!function(t=null){e("#loading-spinner").style.display="block",t&&(t.querySelector("[type=submit]").disabled=!0)}(t.target)}))})()})();