(()=>{"use strict";var __webpack_modules__={771:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{function calculate(str){if(null===str)return"";let result;str=str.replace(/[+-]+$/g,""),str=str.replace(/[^-\(\)\d/\*+\.]/g,"");try{result=eval(str)}catch(e){result=""}return result=void 0===result?"":result,result}function int(e){return isNaN(parseInt(e))?0:parseInt(e)}function coarseRound(e){let t=!1;return e<0&&(e*=-1,t=!0),e=e<50?Math.round(e):e<200?5*Math.round(e/5):e<500?10*Math.round(e/10):e<2e3?50*Math.round(e/50):100*Math.round(e/100),t&&(e*=-1),e}function trimModifier(e){return(e=e.replace(/\([+-]\d+\)$/g,"")).trimEnd()}function explicitSign(e){return e>0?`+${e}`:`${e}`}__webpack_require__.d(__webpack_exports__,{Ie:()=>explicitSign,Kf:()=>calculate,e$:()=>int})}},__webpack_module_cache__={};function __webpack_require__(e){var t=__webpack_module_cache__[e];if(void 0!==t)return t.exports;var n=__webpack_module_cache__[e]={exports:{}};return __webpack_modules__[e](n,n.exports,__webpack_require__),n.exports}__webpack_require__.d=(e,t)=>{for(var n in t)__webpack_require__.o(t,n)&&!__webpack_require__.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},__webpack_require__.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var __webpack_exports__={};(()=>{const e=e=>document.querySelector(e),t=e=>document.querySelectorAll(e);function n(e,t=[]){const n=document.createElement(e);return t.forEach((e=>n.classList.add(e))),n}var a=__webpack_require__(771);window.location.hostname;class r{constructor(e,t,n,a,r=[],s=null){this.sender=parseInt(e),this.key=t,this.type=n,this.timestamp=Date.now(),this.content=a,this.recipients=r,this.label=s}stringify(){return JSON.stringify(this)}}async function s(e,t=null){const n=window.chat.inputEntry,s=window.chat.id,c=window.chat.key,p=window.chat.ws,d=/^\/(\d+,){0,10}\d+/.exec(n.value);let u=[];d&&(u=d[0].substring(1).split(","),u=u.map((e=>parseInt(e))),n.value=n.value.replace(d[0],"").trim());const m=n.value.match(/#\d{1,2}([+-]\d{1,2})?(?=\s|$)/g),h=n.value.match(/#(\d+)d(\d{0,3})([+-/*]*)([0-9\.]+)*/g),f=n.value.match(/D(\d+)d(\d{0,3})([+-/*]*)([0-9\.]+)*/g);if(m){const e=[];m.forEach((t=>{e.push(t.replace("#",""))})),e.forEach((r=>{const s=o("3d").result,l=i((0,a.Kf)(r),s),c=`[ ${r} ‚Üí ${s} (MR ${l.MR} ${l.symbol}) ]`;n.value=n.value.replace(`#${r}`,c),1===e.length&&null===h&&(t=l.symbol)}))}if(h){const e=[];h.forEach((t=>{e.push(t.replace("#",""))})),e.forEach((e=>{const t=`[ ${e} ‚Üí ${o(e).result} ]`;n.value=n.value.replace(`#${e}`,t)}))}if(f){const e=[];f.forEach((t=>{e.push(t.replace("D",""))}));const t=e.map((async e=>{const t=`[ ${e} ‚Üí ${o(e).result} ‚Äì ${(await l())[1]} ]`;n.value=n.value.replace(`D${e}`,t)}));await Promise.all(t)}(m||h||f)&&(e="chat-roll");const g=new r(s,c,e,n.value,u,t);p.send(g.stringify()),n.value=""}function o(e){let t,n,a,r,s=0,o=/^(\d+)d(\d{0,3})([+-/*]*)([0-9\.]+)*/.exec(e);if(null===o)s=isNaN(parseInt(e))?0:parseInt(e),t=0,n="",a="+",r=s;else if(t=parseInt(o[1]),n=""!=o[2]?parseInt(o[2]):6,a=""!=o[3]?o[3]:"+",r=null!=o[4]&&""!=o[4]?parseFloat(o[4]):0,1===t&&6===n&&"-"===a&&2===r)s=Math.floor(5*Math.random());else if(1===t&&6===n&&"-"===a&&3===r)s=Math.floor(4*Math.random());else if(1===t&&6===n&&"-"===a&&4===r)s=Math.floor(3*Math.random());else if(1===t&&6===n&&"-"===a&&r<=5)s=Math.floor(2*Math.random());else{for(let e=0;e<t;e++)s+=Math.floor(Math.random()*n)+1;switch(a){case"+":s+=r;break;case"-":s-=r;break;case"*":s*=r;break;case"/":s/=r}}let i=`${t}d${6===n?"":n}${a}${r}`;return i=i.replace("+0",""),i=i.replace("-0",""),{expression:i,result:s}}function i(e,t){const n=e-t;let a=0;18===t?a=-1:17===t?a=e>=16?0:-1:4===t?a=e<=5?0:1:3===t?a=1:n<=-10?a=-1:n>=10&&t<=7&&(a=1);let r=n>=0?"üü¢":"üî¥";return-1===a&&(r="üòñ"),1===a&&(r="üòé"),{MR:n,symbol:r,critical:a}}async function l(){const e=new FormData;return e.append("roll",o("3d").result),await fetch("/api/localisation-table",{method:"post",body:e}).then((e=>e.json())).then((e=>e.data))}async function c(e,t=null){const n={method:"get"};return t&&(n.method="post",n.body=t),fetch(e,n).then((e=>e.json())).then((e=>e.data))}class p{constructor(t,n){this.form=e(`[data-name=${t}] form`),this.action=n.bind(this),this.form.addEventListener("submit",(async t=>{t.preventDefault();const n=await this.action();null!==n&&(e("#msg-input").value+=n,s("chat-roll"))}))}}const d=localStorage.getItem("version");d&&"2.0"===d||(localStorage.clear(),console.info("localStorage has been reset"),localStorage.setItem("version","2.0"));const u=parseInt(e("#login-element").dataset.id),m=JSON.parse(localStorage.getItem("opponents"))??[],h=new class{constructor(t){this.wrapper=e("[data-name=opponents] [data-role=opponents-wrapper]"),this.template=e("[data-name=opponents] template"),this.list=t,0===this.list.length&&(this.list=[{}]),this.fillWidgets(),this.updateOpponentSelectors(),this.wrapper.addEventListener("change",(e=>this.updateOpponents(e)))}fillWidgets(){this.list.forEach(((e,t)=>{const n=this.template.content.cloneNode(!0);n.querySelector("[data-role=opponent-wrapper]").dataset.index=t,n.querySelector("[data-role=opponent-number]").innerText=t+1,n.querySelector("[name=name]").value=e.name??"",n.querySelector("[name=category]").value=e.category??"std",n.querySelector("[name=dex]").value=e.dex??"",n.querySelector("[name=san]").value=e.san??"",n.querySelector("[name=pain-resistance]").value=e.painResistance??"",n.querySelector("[name=pdvm]").value=e.pdvm??"",n.querySelector("[name=pdv]").value=e.pdv??"",n.querySelector("[name=members]").value=e.members??"",this.wrapper.appendChild(n)}))}updateOpponents(e){const t=e.target.closest("[data-role=opponent-wrapper]"),n=parseInt(t.querySelector("[data-role=opponent-number]").innerText)-1,r="pain-resistance"===e.target.name?"painResistance":e.target.name;["dex","san","pdvm","pdv"].includes(r)&&(e.target.value=(0,a.Kf)(e.target.value)),["dex","san","pdvm"].includes(r)&&e.target.value<=0&&(e.target.value=""),"painResistance"!==r||[-1,0,1].includes(parseInt(e.target.value))||(e.target.value=""),"members"===r&&(e.target.value=e.target.value.toUpperCase());const s=e.target.value;if(this.list[n][r]=""!==s&&Number(s)==s?parseInt(s):s,"name"===r&&""===s&&n<this.list.length-1&&t.remove(),"name"===r&&""!==s&&n===this.list.length-1){const e=this.template.content.cloneNode(!0);this.wrapper.appendChild(e)}this.list=this.list.filter((e=>void 0!==e.name&&""!==e.name)),this.list.push({}),localStorage.setItem("opponents",JSON.stringify(this.list));const o=this.wrapper.querySelectorAll("[data-role=opponent-number]");let i=1;o.forEach((e=>{e.innerText=i,i++})),"name"===r&&this.updateOpponentSelectors()}updateOpponentSelectors(){t("[name=opponent-selector]").forEach((e=>{if(e.innerHTML="",0===Object.entries(this.list[0]).length){const t=n("option");t.value="",t.innerText="‚Äì",e.appendChild(t)}else this.list.forEach(((t,a)=>{if(!t.name)return;const r=n("option");r.value=a,r.innerText=t.name,e.appendChild(r)}));e.addEventListener("change",(e=>{localStorage.setItem("selected-opponent",e.target.value)}));const t=localStorage.getItem("selected-opponent")??0;e.children[t]&&(e.children[t].selected=!0)}))}}(m),f=JSON.parse(localStorage.getItem("skills"))??[],g=(new class{constructor(t){this.wrapper=e("[data-name=scores-tester] [data-role=scores-wrapper]"),this.sortBtn=e("[data-name=scores-tester] [data-role=sort-scores]"),this.template=e("[data-name=scores-tester] template"),this.skills=t,0===this.skills.length&&(this.skills=[{}]),this.fillWidgets(),this.wrapper.addEventListener("change",(e=>this.updateScores(e))),this.sortBtn.addEventListener("click",(e=>{this.skills=this.skills.sort(((e,t)=>e.name&&t.name?e.name.localeCompare(t.name,"fr",{sensitivity:"base"}):e.name&&!t.name?-1:!e.name&&t.name?1:0)),this.wrapper.innerHTML="",this.fillWidgets(),localStorage.setItem("skills",JSON.stringify(this.skills))}))}fillWidgets(){this.skills.forEach(((e,t)=>{const n=this.template.content.cloneNode(!0),a=n.querySelector("form");a.dataset.index=t,a.name.value=e.name??"",a.score.value=e.score??"",a.modif.value=e.modif??"",a.addEventListener("submit",(t=>this.action(t,e))),this.wrapper.appendChild(n)}))}action(t,n){t.preventDefault();const r=o("3d").result,l=i(n.score+(n.modif??0),r),c=0===n.modif||""===n.modif||void 0===n.modif?"":(0,a.Ie)(n.modif);void 0!==n.name&&""!==n.name&&void 0!==n.score&&Number(n.score)==n.score&&(e("#msg-input").value+=`${n.name} (${n.score}${c}) ‚Üí ${r} (MR ${l.MR} ${l.symbol})`,s("chat-roll",l.symbol))}updateScores(e){const t=e.target.closest("form"),n=parseInt(t.dataset.index),r=e.target.name;"score"!==r&&"modif"!==r||(e.target.value=(0,a.Kf)(e.target.value)),"modif"===r&&(e.target.value=(0,a.Ie)(e.target.value));const s=e.target.value;if(this.skills[n][r]=""!==s&&Number(s)==s?parseInt(s):s,"name"===r&&""===s&&t.remove(),"name"===r&&""!==s&&n===this.skills.length-1){const e=this.template.content.cloneNode(!0);this.wrapper.appendChild(e)}this.skills=this.skills.filter((e=>void 0!==e.name&&""!==e.name)),this.skills.push({}),localStorage.setItem("skills",JSON.stringify(this.skills));const o=this.wrapper.querySelectorAll("form");let i=0;o.forEach((e=>{e.dataset.index=i,i++}))}}(f),new p("simple-roll",(function(){const e=o(this.form.expression.value);return`${e.expression} ‚Üí ${e.result}`})),new p("round-counter",(function(){const e=this.form.round,t=this.form.comment,r=(0,a.e$)(e.value);e.value=r+1;const s=t.value.replace(/\d+/g,(e=>{const t=parseInt(e)-1;return h.list[t]&&h.list[t].name?h.list[t].name:e})),o=n("div");o.innerHTML=s;const i=o.textContent||o.innerText;return`*Round ${r}*${""!==i?" ‚Äì "+i:""}`})),new p("widget-damage-location",(async function(){const t=this.form.strength,n=this.form.code,a=this.form.hands,r=this.form.expression,s=await async function(e,t,n){if(parseInt(e)&&t){let a="B."+t,r=new FormData;return r.append("for",e),r.append("notes",a),r.append("mains",n),fetch("/api/weapon-damages",{method:"post",body:r}).then((e=>e.json())).then((e=>e.data.damages.slice(2)))}return null}(t.value,n.value,a.value);s&&(r.value=s);const i=o(r.value),c=await l();return e("[data-name=wound-effect] [name=raw-dmg]").value=i.result,e("[data-name=wound-effect] [name=localisation]").value=c[1],`D√©g√¢ts (${i.expression})&nbsp;: ${i.result} ‚Äì ${c[0]}`})),new p("widget-criticals",(async function(){const e=new FormData(this.form);return e.append("roll-3d",o("3d").result),e.append("roll-1d",o("1d").result),await c("/api/critical-tables",e)})),new p("widget-burst",(async function(){const e=new FormData(this.form),t=await c("/api/burst-hits",e),n=[],a=this.form.expression.value;for(let e=0;e<t;e++){const e=o(a).result,t=this.form.localisation.checked?await l():"",r=t?`‚Äì ${t[0]}`:"";n.push(`${e} pts ${r}`)}let r=`<b>Rafale&nbsp;:</b> Rcl ${this.form.rcl.value} ‚Äì Balles ${this.form.bullets.value} ‚Äì MR ${this.form.mr.value}`;return n.forEach(((e,t)=>{r+=`<br><b>${t+1}.</b> ${e}`})),r})),new p("fright-check",(async function(){const e=(0,a.e$)(this.form.querySelector(["[name=sf-score]"]).value),t=(0,a.e$)(this.form.querySelector(["[name=sf-modif]"]).value),n=new FormData(this.form),r=i(e+t,o("3d").result),s=[];for(let e=0;e<=6;e++)s.push(o("3d").result);return n.append("frightcheck-MR",r.MR),n.append("frightcheck-symbol",r.symbol),n.append("frightcheck-critical",r.critical),n.append("rolls",s.join(",")),await c("/api/fright-check",n)})),new p("general-health-state",(async function(){const e=this.form.querySelector("[name=opponent-selector]").value,t=h.list[e];if(!t||!t.pdvm)return null;const n=new FormData;n.append("san",t.san??null),n.append("pdvm",t.pdvm??null),n.append("pdv",t.pdv??t.pdvm),n.append("pain-resistance",t.painResistance??0),n.append("members",t.members??null);const a=await c("/api/general-state",n);let r=`√âtat g√©n√©ral de <b>${t.name}</b><br>${a.general}`;if(void 0!==a.members&&!a["members-error"])for(const[e,t]of Object.entries(a.members))r+=`<br>${e}&nbsp;: ${t.description}`;return a["members-error"]&&(r+="<br>Membres&nbsp;: donn√©es incoh√©rentes"),r})),new p("wound-effect",(async function(){const t=this.form["opponent-selector"].value,n=h.list[t],a=o(this.form["raw-dmg"].value).result,r=[];for(let e=0;e<7;e++)r.push(o("3d").result);const s=new FormData(this.form);s.append("category",n.category??"std"),s.append("dex",n.dex),s.append("san",n.san),s.append("pdvm",n.pdvm),s.append("pdv",n.pdv??n.pdvm),s.append("pain-resistance",n.painResistance),s.set("raw-dmg",a),s.append("rolls",r);const i=await c("/api/wound-effects",s);if(i.erreur)return"Donn√©es manquantes";let l=`<b>${n.name} ‚Äì ${i["d√©g√¢ts bruts"]} ( ${i["type d√©g√¢ts"]} ${i.localisation})</b>`;l+=`<br>D√©g√¢ts effectifs&nbsp;: ${i["d√©g√¢ts effectifs"]}`,i.recul&&(l+=`<br>Recul de ${i.recul}&nbsp;m.`),i.mort&&(l+=`<br>${i.mort}`),i.mort&&i.mort.includes("üòµ")||(i["autres effets"]&&(l+=`<br>${i["autres effets"]}`),i["sonn√©"]&&!i["perte de conscience"]&&(l+=`<br>${i["sonn√©"]}`),i["perte de conscience"]&&(l+="<br>Le personnage perd conscience."),i.chute&&!i["perte de conscience"]&&(l+="<br>Le personnage ch√ªte."),i["d√©g√¢ts membre"]&&(l+=`<br>${i["d√©g√¢ts membre"]}`),""!==i["√©tat membre"]&&(l+=` (${i["√©tat membre"]})`));const p=e(`[data-role="opponent-wrapper"][data-index="${t}"]`).querySelector("[name=pdv]");return p.value=i.pdv,p.dispatchEvent(new Event("change",{bubbles:!0})),l}))),v=g.form["dmg-type"];v.addEventListener("change",(e=>{const t=g.form["bullet-type"];["b0","b1","b2","b3"].includes(v.value)?t.disabled=!1:(t.value="std",t.disabled=!0)})),new p("bleeding-widget",(async function(){const t=this.form["opponent-selector"].value,n=h.list[t];if(!n.san||!n.pdvm)return"Donn√©es manquantes";const r=(0,a.e$)(this.form.modif.value),s=(0,a.e$)(this.form.severity.value),l=i(n.san+r,o("3d").result),p=new FormData;p.append("san-test",JSON.stringify(l)),p.append("pdvm",n.pdvm),p.append("severity",s);const d=await c("/api/bleeding-effects",p);if(d.error)return"Donn√©es entr√©es incoh√©rentes et/ou manquantes";let u=`H√©morragie¬†: PdV perdu(s) ${d["pdv-loss"]}`;d.comment&&(u+=`<br>${d.comment}`);const m=e(`[data-role="opponent-wrapper"][data-index="${t}"]`).querySelector("[name=pdv]");return""===m.value&&(m.value=n.pdvm),m.value-=d["pdv-loss"],m.dispatchEvent(new Event("change",{bubbles:!0})),u})),new p("explosion-widget",(async function(){const e=this.form["explosion-dmg"].value,t=(o(e).result+o(e).result+o(e).result)/3*1.43,n=new FormData(this.form);n.append("damages",t),console.log(n);const a=await c("/api/explosion-damages",n);return`<b>Explosion¬†:</b> d√©g√¢ts ${a.damages} ‚Äì fragment(s) ${a.fragments} ‚Äì hauteur de chute ${a.height}¬†m`}));const b=new p("object-damages",(async function(){const e=o(this.form["dmg-code"].value).result,t=new FormData(this.form);t.append("dmg-value",e),t.append("rolls",[o("3d").result,o("3d").result,o("3d").result,o("3d").result]),console.log(t);const n=await c("/api/object-damages-effects",t);console.log(n),this.form.pds.value=n.pds;let a=`\n\t\t\t\t<b>D√©g√¢ts ${n.objectType}</b><br>\n\t\t\t\tPdSm&nbsp;: ${n.pdsm} ‚Äì RD&nbsp;: ${n.rd}<br>\n\t\t\t\tD√©g√¢ts&nbsp;: ${n.netDamages} (${n.damagesLevel})<br>\n\t\t\t\tPdS restant&nbsp;: ${n.pds} (${n.stateLevel})\n\t\t\t`;if(n.sideEffects.length){a+="<br>";for(let e of n.sideEffects)a+=`‚Ä¢&nbsp;${e[0]} niv. ${e[1]}<br>`}return a}));b.form["object-type"].addEventListener("change",(async e=>{const t=new FormData;t.append("object-type",e.target.value),console.log(t);const a=await c("/api/object-localisation-options",t);b.form.localisation.innerHTML="",a.forEach((e=>{e=e.charAt(0).toUpperCase()+e.slice(1);const t=n("option");t.innerText=e,b.form.localisation.appendChild(t)}))})),new p("vehicle-collision",(async function(){const e=parseInt(this.form.pdsm.value),t=this.form.severity,n=parseInt(t.value),a=t.options[t.selectedIndex].innerText;if(!e)return;let r;switch(n){case 1:r=Math.round((15+o("3d").result)/100*e);break;case 2:r=Math.round((40+o("3d").result)/100*e);break;case 3:r=Math.round((90+o("3d").result)/100*e);break;case 4:r=Math.round((180+o("6d").result)/100*e);break;case 5:r="v√©hicule d√©truit";break;default:r=0}return`<b>Collision</b> ${a}&nbsp;: d√©g√¢ts ${r}`}));const w=new p("npc-generator",(async function(){const e=new FormData(this.form),t=await c("/api/npc-generator",e);if(t.error)return`/${u} Param√®tres PNJ invalides`;if(t["name-only"])return`/${u} ${t.name}`;const n=t.facialHair?`${t.facialHair},`:"",a="moyenne"!==t.corpulence?`${t.corpulence}, `:"",r="moyenne"!==t.size?`${t.size}, `:"",s="moyenne"!==t.beauty?`${t.beauty}, `:"",o="moyenne"!==t.intelligence?`${t.intelligence}, `:"",i=t.specialTraits?`<br>Choisir une particularit√© parmi&nbsp;: <i>${t.specialTraits}</i>`:"";return`/${u}\n\t\t<b>${t.name}</b><br>\n\t\t${t.hair},\n\t\t${n}\n\t\tyeux ${t.eyes},\n\t\t${a}\n\t\t${r}\n\t\t${s}\n\t\t${o}\n\t\t${t.social}\n\t\t${i}\n\t`}));null!==localStorage.getItem("npc-region")&&(w.form.region.value=localStorage.getItem("npc-region")),w.form.region.addEventListener("change",(()=>{localStorage.setItem("npc-region",w.form.region.value)})),new p("widget-reaction",(async function(){const e=(0,a.e$)(this.form.modifier.value.trim("+")),t=o("1d").result+e,n=new FormData;n.append("reaction-test",t);const r=await c("/api/reaction-test",n);return`/${u} Jet de r√©action (${t}) ‚Üí ${r}`})),new p("wild-generator",(async function(){const e=new FormData(this.form),t=await c("/api/wild-generator",e);return`/${u} ${t}`}));const $=e("[data-role=widget-choices]"),y=e("[data-role=widget-choices] template"),_=JSON.parse(localStorage.getItem("display-widgets"))||{"widget-damage-location":!0,"widget-criticals":!0},S=t("fieldset[data-name]");function k(){S.forEach((e=>e.hidden=!_[e.dataset.name]))}S.forEach((e=>{const t=y.content.cloneNode(!0),n=t.querySelector("input");n.dataset.name=e.dataset.name,_[e.dataset.name]&&(n.checked=!0),n.addEventListener("change",(e=>{_[n.dataset.name]=n.checked,localStorage.setItem("display-widgets",JSON.stringify(_)),k()})),t.querySelector("span").innerHTML=e.querySelector("legend").childNodes[0].textContent.trim(),$.appendChild(t)})),k()})()})();